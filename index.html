<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>Calculadora iPhone</title>
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" href="icon-192.png">
    <link rel="manifest" href="manifest.json">
    <style>
        /* ... (estilos iguales, sin cambios) ... */
    </style>
</head>
<body>
    <div class="calculator">
        <div class="display" id="display"><span>0</span></div>
        <div class="buttons">
            <!-- ... (botones iguales, sin cambios) ... -->
        </div>
    </div>

    <script>
        let currentValue = '0';
        let previousValue = '';
        let operation = null;
        let resetScreen = false;

        const display = document.getElementById('display');
        const clearBtn = document.getElementById('clear');
        const signBtn = document.getElementById('sign');
        const percentBtn = document.getElementById('percent');
        const decimalBtn = document.getElementById('decimal');
        const backspaceBtn = document.getElementById('backspace');
        const equalsBtn = document.getElementById('equals');
        const numberBtns = document.querySelectorAll('.dark-gray:not(#decimal):not(#backspace)');
        const operationBtns = document.querySelectorAll('.orange:not(#equals)');

        clearBtn.addEventListener('click', clear);
        signBtn.addEventListener('click', toggleSign);
        percentBtn.addEventListener('click', percentage);
        decimalBtn.addEventListener('click', addDecimal);
        backspaceBtn.addEventListener('click', backspace);
        equalsBtn.addEventListener('click', calculate);

        numberBtns.forEach(button => {
            button.addEventListener('click', () => appendNumber(button.querySelector('span').textContent));
        });

        operationBtns.forEach(button => {
            button.addEventListener('click', () => setOperation(button.querySelector('span').textContent));
        });

        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        });

        // === MODIFICACIÓN APLICADA AQUÍ ===
        function formatNumberWithCommas(numberStr) {
            const [integerPart, decimalPart] = numberStr.split('.');
            const formattedInteger = parseInt(integerPart, 10).toLocaleString('en-US');
            return decimalPart !== undefined ? `${formattedInteger}.${decimalPart}` : formattedInteger;
        }

        function updateDisplay() {
            display.querySelector('span').textContent = formatNumberWithCommas(currentValue);
        }

        function appendNumber(number) {
            if (currentValue === '0' || resetScreen) {
                currentValue = '';
                resetScreen = false;
            }
            currentValue += number;
            updateDisplay();
        }

        function addDecimal() {
            if (resetScreen) {
                currentValue = '0';
                resetScreen = false;
            }
            if (!currentValue.includes('.')) {
                currentValue += '.';
                updateDisplay();
            }
        }

        function clear() {
            currentValue = '0';
            previousValue = '';
            operation = null;
            resetScreen = false;
            operationBtns.forEach(btn => btn.classList.remove('operator-active'));
            updateDisplay();
        }

        function toggleSign() {
            currentValue = (parseFloat(currentValue) * -1).toString();
            updateDisplay();
        }

        function percentage() {
            currentValue = (parseFloat(currentValue) / 100).toString();
            updateDisplay();
        }

        function backspace() {
            if (currentValue.length === 1 || (currentValue.length === 2 && currentValue.startsWith('-'))) {
                currentValue = '0';
            } else {
                currentValue = currentValue.slice(0, -1);
            }
            updateDisplay();
        }

        function setOperation(op) {
            if (operation !== null) calculate();
            previousValue = currentValue;
            operation = op;
            resetScreen = true;

            operationBtns.forEach(btn => btn.classList.remove('operator-active'));
            event.target.classList.add('operator-active');
        }

        function calculate() {
            let result;
            const prev = parseFloat(previousValue);
            const current = parseFloat(currentValue);

            if (isNaN(prev) || isNaN(current)) return;

            switch (operation) {
                case '+': result = prev + current; break;
                case '−': result = prev - current; break;
                case '×': result = prev * current; break;
                case '÷': result = prev / current; break;
                default: return;
            }

            currentValue = result.toString();
            operation = null;
            resetScreen = true;
            operationBtns.forEach(btn => btn.classList.remove('operator-active'));
            updateDisplay();
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then(registration => {
                    console.log('ServiceWorker registrado');
                }).catch(err => {
                    console.log('Error al registrar ServiceWorker:', err);
                });
            });
        }
    </script>
</body>
</html>
